<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Diabetic Foot Ulcer Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-section {
            @apply bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8;
        }
        .info-title {
            @apply text-2xl font-bold text-gray-800 dark:text-white mb-4 border-b-2 border-blue-500 pb-2;
        }
        .info-list {
            @apply list-disc list-inside space-y-2 text-gray-600 dark:text-gray-300;
        }
        .tab-button {
            @apply px-4 py-2 font-semibold rounded-t-lg transition-colors duration-300;
        }
        .tab-button.active {
            @apply bg-blue-600 text-white;
        }
        .tab-button:not(.active) {
            @apply bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600;
        }
        .tab-content {
            @apply hidden;
        }
        .tab-content.active {
            @apply block;
        }
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        #image-preview-wrapper {
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Predictor Section -->
        <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden mb-8">
            <div class="p-6 sm:p-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 dark:text-white">
                    Diabetic Foot Ulcer Visual Analyzer
                </h1>
                <p class="text-center text-gray-600 dark:text-gray-400 mt-2">
                    Upload an image, use your webcam, and highlight areas for analysis.
                </p>
            </div>

            <div class="p-6 sm:p-8 border-t border-gray-200 dark:border-gray-700">
                <div class="flex flex-col items-center">
                    <div id="image-preview-wrapper" class="w-full max-w-md h-64 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center mb-6 border-2 border-dashed border-gray-300 dark:border-gray-600 overflow-hidden">
                        <p id="image-placeholder" class="text-gray-500 dark:text-gray-400">Image preview will appear here</p>
                        <img id="image-preview" src="" alt="Image Preview" class="hidden max-w-full max-h-full object-contain"/>
                        <canvas id="drawing-canvas"></canvas>
                    </div>

                    <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4 w-full max-w-md">
                        <label for="upload-button" class="w-full sm:w-auto cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 text-center">
                            Select Image
                        </label>
                        <input id="upload-button" type="file" class="hidden" accept="image/png, image/jpeg, image/jpg">
                        
                        <button id="webcam-button" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">
                            Use Webcam
                        </button>

                        <button id="predict-button" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Get Description
                        </button>
                    </div>
                </div>
            </div>

            <div id="result-container" class="p-6 sm:p-8 border-t border-gray-200 dark:border-gray-700 hidden">
                 <div id="loader" class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto mb-4 hidden"></div>
                 <div id="prediction-content">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-white mb-2 text-left">Visual Description</h2>
                    <p id="prediction-text-desc" class="text-lg text-left text-gray-600 dark:text-gray-300 mb-4 whitespace-pre-wrap"></p>
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-white mb-2 text-left">Conclusion</h2>
                    <p id="prediction-text-conc" class="text-lg text-left text-gray-600 dark:text-gray-300 mb-6 whitespace-pre-wrap"></p>
                    <button id="copy-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Copy Results</button>
                 </div>
            </div>
             <div id="error-container" class="p-6 sm:p-8 border-t border-gray-200 dark:border-gray-700 text-center hidden">
                <h2 class="text-xl sm:text-2xl font-semibold text-red-500 mb-2">Error</h2>
                <p id="error-text" class="text-lg text-red-400"></p>
            </div>
        </div>

        <!-- Tabs for Information and History -->
        <div class="max-w-2xl mx-auto">
            <div class="flex border-b border-gray-300 dark:border-gray-600">
                <button class="tab-button active" data-tab="about">About</button>
                <button class="tab-button" data-tab="symptoms">Symptoms</button>
                <button class="tab-button" data-tab="prevention">Prevention</button>
                <button class="tab-button" data-tab="history">History</button>
            </div>
            
            <div id="about" class="tab-content active info-section">
                <h2 class="info-title">About Diabetic Foot Ulcers (DFU)</h2>
                <p class="text-gray-600 dark:text-gray-300">A diabetic foot ulcer is an open sore or wound that occurs in approximately 15 percent of patients with diabetes and is commonly located on the bottom of the foot...</p>
            </div>
            <div id="symptoms" class="tab-content info-section">
                <h2 class="info-title">Common Symptoms</h2>
                <ul class="info-list">
                    <li>Any drainage from the foot that might stain socks or leak out in shoes.</li>
                    <li>Unusual swelling, irritation, redness, or odors from one or both feet.</li>
                    <li>Black tissue (eschar) surrounding a wound.</li>
                    <li>Numbness or loss of feeling in the feet or toes.</li>
                </ul>
            </div>
            <div id="prevention" class="tab-content info-section">
                <h2 class="info-title">Prevention & Further Reading</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4">Proactive care is the best defense:</p>
                <ul class="info-list">
                    <li><strong>Inspect your feet daily:</strong> Check for cuts, blisters, redness, swelling, or nail problems.</li>
                    <li><strong>Wash your feet daily:</strong> Use lukewarm water and dry them gently.</li>
                    <li><strong>Wear proper footwear:</strong> Never walk barefoot.</li>
                    <li><strong>Manage blood sugar:</strong> Keeping glucose levels in your target range is key.</li>
                </ul>
                <h3 class="text-lg font-semibold mt-6 mb-2 text-gray-700 dark:text-gray-200">Reputable Sources:</h3>
                <ul class="info-list">
                    <li><a href="https://diabetes.org/foot-complications" target="_blank" class="text-blue-500 hover:underline">American Diabetes Association</a></li>
                    <li><a href="https://www.mayoclinic.org/diseases-conditions/diabetic-neuropathy/symptoms-causes/syc-20371580" target="_blank" class="text-blue-500 hover:underline">Mayo Clinic - Diabetic Neuropathy</a></li>
                    <li><a href="https://www.niddk.nih.gov/health-information/diabetes/overview/preventing-problems/foot-problems" target="_blank" class="text-blue-500 hover:underline">National Institute of Diabetes (NIDDK)</a></li>
                </ul>
            </div>
            <div id="history" class="tab-content info-section">
                <div class="flex justify-between items-center">
                    <h2 class="info-title">Prediction History</h2>
                    <button id="clear-history-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Clear All</button>
                </div>
                <div id="history-container" class="space-y-4 mt-4">
                    <p id="no-history-text">No predictions have been made yet.</p>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
            <p>Disclaimer: This tool is for informational purposes only and not a substitute for professional medical advice, diagnosis, or treatment.</p>
        </footer>
    </div>
    
    <!-- Webcam Modal -->
    <div id="webcam-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-xl">
            <video id="webcam-video" autoplay class="w-full max-w-lg rounded"></video>
            <div class="flex justify-center mt-4 space-x-4">
                <button id="capture-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Capture</button>
                <button id="close-webcam-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- DOM Element References ---
        const uploadButton = document.getElementById('upload-button');
        const predictButton = document.getElementById('predict-button');
        const imagePreview = document.getElementById('image-preview');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const resultContainer = document.getElementById('result-container');
        const predictionTextDesc = document.getElementById('prediction-text-desc');
        const predictionTextConc = document.getElementById('prediction-text-conc');
        const loader = document.getElementById('loader');
        const errorContainer = document.getElementById('error-container');
        const errorText = document.getElementById('error-text');
        const copyButton = document.getElementById('copy-button');
        const webcamButton = document.getElementById('webcam-button');
        const webcamModal = document.getElementById('webcam-modal');
        const webcamVideo = document.getElementById('webcam-video');
        const captureButton = document.getElementById('capture-button');
        const closeWebcamButton = document.getElementById('close-webcam-button');
        const historyContainer = document.getElementById('history-container');
        const noHistoryText = document.getElementById('no-history-text');
        const clearHistoryButton = document.getElementById('clear-history-button');
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const ctx = drawingCanvas.getContext('2d');

        // --- State Variables ---
        let base64ImageData = null;
        let webcamStream = null;
        let history = [];
        let rect = {};
        let drag = false;

        // --- Event Listeners ---
        
        // Image Upload
        uploadButton.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => handleImage(e.target.result);
                reader.readAsDataURL(file);
            }
        });

        // Webcam
        webcamButton.addEventListener('click', startWebcam);
        closeWebcamButton.addEventListener('click', stopWebcam);
        captureButton.addEventListener('click', captureFrame);

        // Prediction
        predictButton.addEventListener('click', handlePrediction);

        // Copy Button
        copyButton.addEventListener('click', copyResults);

        // Tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                tabContents.forEach(content => {
                    content.id === target ? content.classList.add('active') : content.classList.remove('active');
                });
                tabs.forEach(t => {
                    t.dataset.tab === target ? t.classList.add('active') : t.classList.remove('active');
                });
            });
        });

        // History
        clearHistoryButton.addEventListener('click', clearHistory);

        // Drawing Canvas
        drawingCanvas.addEventListener('mousedown', (e) => {
            rect.startX = e.offsetX;
            rect.startY = e.offsetY;
            drag = true;
        });
        drawingCanvas.addEventListener('mouseup', () => drag = false);
        drawingCanvas.addEventListener('mousemove', drawRect);
        drawingCanvas.addEventListener('mouseleave', () => drag = false);


        // --- Functions ---

        function handleImage(imageDataUrl) {
            imagePreview.src = imageDataUrl;
            imagePreview.classList.remove('hidden');
            imagePlaceholder.classList.add('hidden');
            predictButton.disabled = false;
            base64ImageData = imageDataUrl.split(',')[1];
            
            // Setup canvas for drawing
            imagePreview.onload = () => {
                drawingCanvas.width = imagePreview.clientWidth;
                drawingCanvas.height = imagePreview.clientHeight;
                ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                rect = {}; // Clear previous rectangle
            };

            resultContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }

        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamVideo.srcObject = webcamStream;
                webcamModal.classList.remove('hidden');
            } catch (err) {
                showError("Could not access webcam. Please ensure you have a camera and have granted permission.");
                console.error("Webcam error:", err);
            }
        }

        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
            webcamModal.classList.add('hidden');
        }

        function captureFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = webcamVideo.videoWidth;
            canvas.height = webcamVideo.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(webcamVideo, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg');
            handleImage(dataUrl);
            stopWebcam();
        }
        
        function drawRect(e) {
            if (!drag) return;
            ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            rect.w = e.offsetX - rect.startX;
            rect.h = e.offsetY - rect.startY;
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(rect.startX, rect.startY, rect.w, rect.h);
        }

        async function handlePrediction() {
            if (!base64ImageData) {
                showError("Please select an image first.");
                return;
            }
            
            loader.classList.remove('hidden');
            resultContainer.classList.remove('hidden');
            document.getElementById('prediction-content').classList.add('hidden');
            errorContainer.classList.add('hidden');

            try {
                let prompt = `Analyze the foot in this image. First, provide a neutral, factual "Visual Description" of what you see (skin color, texture, marks). Then, provide a "Conclusion" based on your visual analysis. Frame your final conclusion as 'Conclusion: Signs consistent with a diabetic foot ulcer are likely present.' or 'Conclusion: No clear signs of a diabetic foot ulcer are present.'`;

                if (rect.w && rect.h) {
                    prompt += ` Pay special attention to the region highlighted in a box with top-left coordinates (${Math.round(rect.startX)}, ${Math.round(rect.startY)}) and dimensions ${Math.round(rect.w)}x${Math.round(rect.h)} pixels.`
                }
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                };
                
                const apiKey = "AIzaSyAR6QbvZl_g4L44A0DfiZ6JHSG3rqLEbXs"; // Replace with your key

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    if (response.status === 403) throw new Error(`Authentication Failed (Error 403). Ensure API key is valid.`);
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();

                if (result.promptFeedback && result.promptFeedback.blockReason) {
                    throw new Error(`Request was blocked. Reason: ${result.promptFeedback.blockReason}.`);
                }

                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const fullText = result.candidates[0].content.parts[0].text;
                    displayPrediction(fullText);
                    saveToHistory(base64ImageData, fullText);
                } else {
                    throw new Error("The model did not return a valid response.");
                }

            } catch (error) {
                console.error("Error during prediction:", error);
                showError(error.message);
            } finally {
                loader.classList.add('hidden');
                document.getElementById('prediction-content').classList.remove('hidden');
            }
        }

        function displayPrediction(fullText) {
            let desc = "Could not parse description.";
            let conc = "Could not parse conclusion.";

            const conclusionIndex = fullText.toLowerCase().indexOf('conclusion:');
            if (conclusionIndex !== -1) {
                desc = fullText.substring(0, conclusionIndex).replace('Visual Description:', '').trim();
                conc = fullText.substring(conclusionIndex).replace('Conclusion:', '').trim();
            } else {
                desc = fullText; // If parsing fails, show full text in description
            }
            
            predictionTextDesc.textContent = desc;
            predictionTextConc.textContent = conc;
        }

        function copyResults() {
            const textToCopy = `Visual Description:\n${predictionTextDesc.textContent}\n\nConclusion:\n${predictionTextConc.textContent}`;
            
            // Create a temporary textarea element to hold the text
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            
            // Make the textarea invisible
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                // Execute the copy command
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => { copyButton.textContent = 'Copy Results'; }, 2000);
                } else {
                    showError('Failed to copy results.');
                }
            } catch (err) {
                showError('Failed to copy results.');
                console.error('Fallback: Oops, unable to copy', err);
            }
            
            document.body.removeChild(textArea);
        }

        function saveToHistory(imageData, predictionText) {
            const historyItem = {
                id: Date.now(),
                image: imageData,
                prediction: predictionText
            };
            history.unshift(historyItem);
            localStorage.setItem('dfuHistory', JSON.stringify(history));
            renderHistory();
        }

        function loadHistory() {
            const storedHistory = localStorage.getItem('dfuHistory');
            if (storedHistory) {
                history = JSON.parse(storedHistory);
            }
            renderHistory();
        }

        function renderHistory() {
            historyContainer.innerHTML = ''; // Clear current view
            if (history.length === 0) {
                historyContainer.appendChild(noHistoryText);
                noHistoryText.classList.remove('hidden');
                clearHistoryButton.classList.add('hidden');
            } else {
                noHistoryText.classList.add('hidden');
                clearHistoryButton.classList.remove('hidden');
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-4 p-2 border rounded-lg dark:border-gray-600';
                    div.innerHTML = `
                        <img src="data:image/jpeg;base64,${item.image}" class="w-20 h-20 object-cover rounded-md"/>
                        <p class="text-sm text-gray-600 dark:text-gray-300 flex-1">${item.prediction.substring(0, 150)}...</p>
                    `;
                    historyContainer.appendChild(div);
                });
            }
        }
        
        function clearHistory() {
            if (confirm("Are you sure you want to clear all prediction history?")) {
                history = [];
                localStorage.removeItem('dfuHistory');
                renderHistory();
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorContainer.classList.remove('hidden');
            resultContainer.classList.add('hidden');
        }

        // Initial Load
        loadHistory();
    </script>
</body>
</html>
